<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Judul akan diupdate oleh JavaScript -->
    <title>Detail Anime</title>
    <link rel="icon" href="Gambar/Logo-APL-Myanime.png" type="image/x-icon" />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- ================================================== -->
    <!-- --- STYLE CSS (Disalin dari index.html + Tambahan Detail) --- -->
    <!-- ================================================== -->
<style>
      /* Reset dan Base Styles */
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { width: 100%; min-height: 100vh; scroll-behavior: smooth; }
      body { background-color: #181818; color: #fff; font-family: sans-serif; overflow-x: hidden; background-image: radial-gradient(#021027, #000000); position: relative; z-index: 1; }
      body::-webkit-scrollbar { display: none; }

      /* Style Partikel */
      #particles-background { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: -2; overflow: hidden; }
      .circle-container { position: absolute; width: 5px; height: 5px; animation: move-frames 15s linear infinite; }
      .circle { width: 100%; height: 100%; border-radius: 50%; mix-blend-mode: screen; background-image: radial-gradient(hsl(180, 100%, 80%), hsl(180, 100%, 80%) 10%, hsla(180, 100%, 80%, 0) 56%); animation: fade-frames 2.5s infinite ease-in-out alternate, scale-frames 3.5s infinite ease-in-out alternate; }
      @keyframes fade-frames { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
      @keyframes scale-frames { 0%, 100% { transform: scale(0.6); } 50% { transform: scale(1.4); } }
      @keyframes move-frames { from { transform: translate3d(-10vw, 110vh, 0); opacity: 0; } 20%, 80% { opacity: 1; } to { transform: translate3d(110vw, -10vh, 0); opacity: 0; } }
      .circle-container:nth-child(1) { width: 8px; height: 8px; animation-duration: 12s; animation-delay: 1s; left: 10%; }
      .circle-container:nth-child(2) { width: 5px; height: 5px; animation-duration: 19s; animation-delay: 4s; left: 50%; }
      .circle-container:nth-child(3) { width: 10px; height: 10px; animation-duration: 15s; animation-delay: 7s; left: 90%; }
      
      .container { max-width: 1200px; margin: 0 auto; padding: 20px 15px; position: relative; z-index: 2; }
      .container a { text-decoration: none; color: #ccc; }

      /* === HEADER BARU & KONSISTEN === */
      .abt { background-color: rgba(24, 24, 24, 0.85); backdrop-filter: blur(8px); position: fixed; top: 0; left: 0; right: 0; padding: 10px 15px; z-index: 1001; display: flex; justify-content: flex-start; align-items: center; gap: 15px; border-bottom: 1px solid rgba(255, 162, 0, 0.2); }
      .abt a { position: relative; text-decoration: none; color: #ccc; background-color: transparent; padding: 5px 10px; border-radius: 6px; font-weight: bold; transition: color 0.3s ease, background-color 0.3s ease; }
      .abt a:hover { color: #ffa200; background-color: rgba(255, 162, 0, 0.1); }
      
      /* Logo MyAnime di Pojok Kanan Atas */
      .abt::after {
        content: "MyAnime";
        font-family: "Play", sans-serif;
        font-weight: bold;
        font-size: 1.5em;
        color: #ffa200;
        text-shadow: 0 0 10px #ff6b00;
        position: absolute;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        pointer-events: none;
      }
      
      /* Sembunyikan Navigasi Lama & Reset Header */
      nav, .profile-btn { display: none !important; }
      header { padding-top: 0 !important; margin-top: 50px; }
      /* === AKHIR HEADER BARU === */

      /* Konten Utama */
      main { position: relative; z-index: 2; padding-top: 20px; }
      .back-btn { display: inline-block; margin-bottom: 25px; padding: 8px 16px; background-color: #3a3a3a; color: #ccc; border: 1px solid #555; border-radius: 20px; text-decoration: none; font-weight: bold; transition: all 0.3s ease; }
      .back-btn:hover { background-color: #ffa200; color: #181818; border-color: #ffa200; transform: translateX(-3px); }

      /* Layout Detail Anime */
      #anime-title.detail-main-title { font-size: clamp(2em, 6vw, 3em); color: #ffa200; text-align: center; margin-bottom: 30px; font-weight: bold; text-shadow: 0 0 8px rgba(255, 162, 0, 0.4); }
      .detail-content-wrapper { display: flex; flex-direction: column; gap: 30px; align-items: center; }
      .anime-poster { display: block; width: 100%; max-width: 280px; height: auto; border-radius: 12px; object-fit: cover; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5); border: 3px solid rgba(255, 162, 0, 0.3); transition: transform 0.3s ease; }
      .anime-poster:hover { transform: scale(1.03); }
      .anime-info { width: 100%; display: flex; flex-direction: column; gap: 25px; }
      .meta-info { display: flex; flex-direction: column; gap: 25px; width: 100%; }
      .info-box, .genre-box, .synopsis-box { background-color: rgba(40, 40, 40, 0.8); backdrop-filter: blur(4px); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 162, 0, 0.15); width: 100%; }
      .info-box h3, .genre-box h3, .synopsis-box h3 { color: #ffa200; font-size: 1.4em; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid rgba(255, 162, 0, 0.2); font-weight: bold; }
      .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px 20px; }
      .info-item { font-size: 0.95em; color: #eee; line-height: 1.5; }
      .info-item strong { color: #ffa200; margin-right: 5px; font-weight: 600; }
      .genre-list { display: flex; flex-wrap: wrap; gap: 8px; }
      .genre-tag { background-color: #3a3a3a; color: #ccc; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; border: 1px solid #555; transition: all 0.2s ease; cursor: default; }
      .genre-tag:hover { background-color: #ffa200; color: #181818; border-color: #ffa200; }
      .synopsis-text { color: #ccc; font-size: 1em; line-height: 1.7; text-align: justify; }
      .action-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
      .btn-download, .btn-streaming { display: inline-flex; align-items: center; gap: 8px; padding: 12px 25px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 1em; cursor: pointer; transition: all 0.3s ease; border: none; text-align: center; min-width: 150px; justify-content: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }
      .btn-download { background-color: #17a2b8; color: white; }
      .btn-download:hover { background-color: #138496; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(23, 162, 184, 0.4); }
      .btn-streaming { background-color: #ffa200; color: #181818; }
      .btn-streaming:hover { background-color: #ff8c00; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 162, 0, 0.4); }

      /* Popup Season & Loader */
      .season-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background-color: #282828; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); z-index: 1005; border: 1px solid rgba(255, 162, 0, 0.2); }
      .season-popup h3 { color: #ffa200; text-align: center; margin: 0 0 25px 0; font-size: 1.5em; }
      .season-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
      .season-item { background-color: #3a3a3a; color: #eee; padding: 12px 18px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; transition: all 0.2s ease; border: 1px solid #555; }
      .season-item:hover { background-color: #ffa200; color: #181818; border-color: #ffa200; }
      .close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; color: #aaa; cursor: pointer; transition: color 0.2s ease; line-height: 1; }
      .close-btn:hover { color: #fff; }
      #blur-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1004; }
      #loader { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); border: 8px solid #3a3a3a; border-top: 8px solid #ffa200; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; z-index: 1006; }
      @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

      /* Error & Notifikasi */
      .error-container { text-align: center; padding: 50px 20px; color: #eee; position: relative; z-index: 2; }
      .error-container h1 { color: #ffa200; font-size: 2em; margin-bottom: 15px; }
      .error-container p { color: #ccc; margin-bottom: 25px; }
      #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 25px; color: white; font-weight: bold; z-index: 10000; opacity: 0; transition: opacity 0.3s ease, bottom 0.3s ease; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }
      #notification.visible { opacity: 1; bottom: 30px; pointer-events: auto; }
      #notification.success { background: linear-gradient(45deg, #28a745, #218838); }
      #notification.error { background: linear-gradient(45deg, #dc3545, #c82333); }
      #notification.info { background: linear-gradient(45deg, #17a2b8, #138496); }

      /* Footer */
      .footer { background-color: #1f1f1f; color: #aaa; padding: 30px 0; font-size: 14px; position: relative; z-index: 3; margin-top: 50px; border-top: 1px solid #333; }
      .footer-section { display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap; max-width: 1200px; margin: 0 auto; padding: 0 15px; gap: 30px; }
      .footer-item { flex: 1; min-width: 220px; margin-bottom: 20px; padding: 0 10px; text-align: left; }
      .footer-item h3 { margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid #444; padding-bottom: 8px; color: #ffa200; font-weight: bold; }
      .footer-item p { margin: 0 0 8px 0; display: flex; align-items: center; font-size: 14px; line-height: 1.6; color: #ccc; }
      .footer-item p a { color: #ccc; text-decoration: none; transition: color 0.3s ease; margin-left: 5px; }
      .footer-item p a:hover { color: #ffa200; text-decoration: underline; }
      .social-icon { margin-right: 10px; width: 20px; color: #aaa; transition: all 0.3s ease; }
      .footer-item p a:hover .social-icon { transform: scale(1.2) rotate(5deg); color: #ffa200; }
      
      /* Media Queries */
      @media (min-width: 769px) {
        .detail-content-wrapper { flex-direction: row; align-items: flex-start; gap: 40px; }
        .anime-poster { flex-shrink: 0; width: 35%; max-width: 320px; }
        .anime-info { flex-grow: 1; width: auto; }
        .meta-info { flex-direction: row; gap: 30px; align-items: flex-start; }
        .info-box { flex: 2; }
        .genre-box { flex: 1; }
        .action-buttons { justify-content: flex-start; }
      }
      @media (max-width: 768px) {
        .footer-section { flex-direction: column; align-items: center; text-align: center; }
        .footer-item { width: 95%; text-align: center; }
        .footer-item h3, .footer-item p { justify-content: center; }
      }
      @media (max-width: 480px) {
        #anime-title.detail-main-title { font-size: 1.8em; }
        .info-grid { grid-template-columns: 1fr; }
      }
    </style>    <!-- ================================================== -->
    <!-- --- AKHIR STYLE CSS --- -->
    <!-- ================================================== -->
</head>
<body>
    <!-- Background Partikel -->
    <div id="particles-background">
      <!-- 100 div.circle-container -->
      <div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div><div class="circle-container"><div class="circle"></div></div>
    </div>

    <!-- ============================================= -->
    <!-- === BAGIAN HTML YANG DIPERBAIKI (HEADER) === -->
    <!-- ============================================= -->

    <!-- Bar Atas (Fixed) -->
    <div class="abt">
      <a href="About.html">About</a>
      <a href="index.html">Beranda</a>
      <!-- Logo MyAnime akan ditambahkan oleh CSS di sini -->
    </div>

    <!-- Header Kosong (Hanya untuk Jarak) -->
    <header>
      <!-- Tidak perlu ada apa-apa di sini -->
    </header>

    <!-- ============================================= -->
    <!-- === AKHIR BAGIAN YANG DIPERBAIKI === -->
    <!-- ============================================= -->


    <!-- Konten Utama Detail Anime -->
    <main>
        <div class="container">
            <a href="index.html" class="back-btn">← Kembali ke Beranda</a>

            <!-- Elemen untuk menampilkan detail anime -->
            <h1 id="anime-title" class="detail-main-title">Memuat Judul...</h1>

            <div class="detail-content-wrapper">
                <img id="anime-image" src="Gambar/default-thumbnail.png" alt="Poster Anime" class="anime-poster" /> <!-- Gambar default -->

                <div class="anime-info">
                    <div class="meta-info">
                        <div class="info-box">
                            <h3>Informasi</h3>
                            <div class="info-grid" id="anime-meta">
                                <!-- Metadata akan dimuat di sini -->
                                <p>Memuat informasi...</p>
                            </div>
                        </div>
                        <div class="genre-box">
                            <h3>Genre</h3>
                            <div class="genre-list" id="anime-genres">
                                <!-- Genre akan dimuat di sini -->
                                 <p>Memuat genre...</p>
                            </div>
                        </div>
                    </div>

                    <div class="synopsis-box">
                        <h3>Sinopsis</h3>
                        <p id="anime-desc" class="synopsis-text">Memuat sinopsis...</p>
                    </div>

                    <div class="action-buttons">
                        <a id="download-btn" class="btn-download" style="display: none;"> Download</a> <!-- Sembunyikan default -->
                        <a id="streaming-link" class="btn-streaming" style="display: none;">► Streaming</a> <!-- Sembunyikan default -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notifikasi -->
    <div id="notification"></div>

    <!-- Popup Season & Loader/Overlay -->
    <div id="blur-overlay"></div>
    <div id="loader" style="display: none"></div>

    <!-- Popup Season Download -->
    <div id="seasonPopup" class="season-popup">
      <span class="close-btn" onclick="closeSeasonPopup()">×</span>
      <h3>Pilih Season Download</h3>
      <ul class="season-list" id="seasonList"></ul>
    </div>

    <!-- Popup Season Streaming -->
    <div id="streamingSeasonPopup" class="season-popup">
      <span class="close-btn" onclick="closeStreamingSeasonPopup()">×</span>
      <h3>Pilih Season Streaming</h3>
      <ul class="season-list" id="streamingSeasonList"></ul>
    </div>

    <!-- Footer (Salin dari index.html) -->
    <footer class="footer">
        <div class="footer-section">
            <div class="footer-item">
                <h3>Hak Cipta</h3>
                <p>© 2024 MyAnime.</p>
                <p>Dikelola dan dikembangkan oleh Ransyah</p> <!-- Sesuaikan teks -->
            </div>
            <div class="footer-item">
                <h3>Ikuti & Support Kami</h3>
                 <div class="social-links-container">
                     <p><a href="https://www.instagram.com/ransyah_32/" target="_blank" rel="noopener noreferrer"><i class="fab fa-instagram social-icon"></i> Instagram</a></p>
                     <p><a href="mailto:rizky1234kb@gmail.com"><i class="fas fa-envelope social-icon"></i> Email</a></p>
                 </div>
            </div>
            <div class="footer-item">
                <h3>Hubungi Kami</h3>
                <p><a href="mailto:rizky1234kb@gmail.com">rizky1234kb@gmail.com</a></p>
            </div>
        </div>
    </footer>

    <!-- Script Eksternal (Google Sign In & JWT Decode) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script>

    <!-- Script Internal Aplikasi (Gabungan) -->
    <script>
        // --- Fungsi Notifikasi (Salin dari index.html) ---
        function showNotification(message, type = "info", duration = 3000) {
            const notification = document.getElementById("notification");
            if (!notification) { console.warn("Notification element not found!"); alert(message); return; }
            if (notification.timerId) { clearTimeout(notification.timerId); notification.classList.remove("visible"); void notification.offsetWidth; }
            notification.className = ""; notification.classList.add("notification", type); notification.textContent = message;
             requestAnimationFrame(() => { notification.classList.add("visible"); });
            notification.timerId = setTimeout(() => { notification.classList.remove("visible"); notification.timerId = null; }, duration);
        }

        // --- Fungsi Auth & Menu (Salin dari index.html) ---
        const CLIENT_ID_AUTH = "429779218315-46milavmlmmbb1b1v5p6v4mbh1o40uk6.apps.googleusercontent.com"; // Gunakan nama variabel unik
        const REDIRECT_URI_AUTH = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) + 'index.html'; // Arahkan redirect ke index.html

        function handleLogin() {
            console.log("Attempting Google login...");
            localStorage.removeItem("access_token"); localStorage.removeItem("user_info"); sessionStorage.removeItem("currentUser");
            const oauth2Url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID_AUTH}&redirect_uri=${REDIRECT_URI_AUTH}&response_type=token&scope=email profile&prompt=select_account`;
            window.location.href = oauth2Url;
        }

        function handleLogout() {
            if (!confirm("Anda yakin ingin keluar sekarang?")) { return; }
            console.log("Logging out...");
            localStorage.removeItem("access_token"); localStorage.removeItem("user_info"); sessionStorage.removeItem("currentUser");
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) { try { google.accounts.id.disableAutoSelect(); } catch (e) { console.warn("Failed to disable Google auto-select:", e); } }
            updateMenu(); // Update UI
            showNotification("Anda telah berhasil logout.", "info");
        }

        async function getUserInfo(accessToken) {
            console.log("Fetching user info...");
            try {
                const response = await fetch("https://www.googleapis.com/oauth2/v2/userinfo", { headers: { Authorization: `Bearer ${accessToken}` } });
                if (!response.ok) { if (response.status === 401) { console.warn("Token invalid/expired."); localStorage.removeItem("access_token"); localStorage.removeItem("user_info"); sessionStorage.removeItem("currentUser"); } throw new Error(`Failed fetch: ${response.status}`); }
                const userInfo = await response.json();
                if (!userInfo || (!userInfo.id && !userInfo.sub)) { throw new Error("Incomplete user data."); }
                return userInfo;
            } catch (error) {
                console.error("Failed to get user info:", error);
                localStorage.removeItem("access_token"); localStorage.removeItem("user_info"); sessionStorage.removeItem("currentUser");
                return null;
            }
        }

        async function updateMenu() {
             console.log("Updating menu...");
             const menu = document.getElementById("menu");
             if (!menu) return;
             const accessToken = localStorage.getItem("access_token");
             let userInfo = JSON.parse(sessionStorage.getItem("currentUser")) || JSON.parse(localStorage.getItem("user_info") || "null");

            if (accessToken && userInfo && userInfo.id) {
                 const profilePic = userInfo.picture || 'Gambar/default-avatar.png';
                 const userName = userInfo.name || 'User';
                 menu.innerHTML = `
                     <li><a href="index.html">HOME</a></li>
                     <li><a href="favorites.html">Favorites</a></li>
                     <li>
                         <a href="#" id="logout-btn" class="profile-btn" title="Klik untuk Logout">
                             <img src="${profilePic}" alt="Profile" class="profile-img" onerror="this.src='Gambar/default-avatar.png';">
                             <span>${userName}</span>
                         </a>
                     </li>`;
                 const logoutBtn = document.getElementById('logout-btn');
                 if(logoutBtn) logoutBtn.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
             } else {
                 menu.innerHTML = `
                     <li><a href="index.html">HOME</a></li>
                     <li><a href="favorites.html">Favorites</a></li> <!-- Tetap tampilkan Favorites -->
                     <li><a href="#" id="google-login-btn">LOGIN</a></li>`;
                 const googleLoginBtn = document.getElementById("google-login-btn");
                 if(googleLoginBtn) googleLoginBtn.addEventListener('click', (e) => { e.preventDefault(); handleLogin(); });
             }
        }

        async function initAuth() {
             console.log("Initializing Auth...");
             // Di halaman detail, kita hanya perlu mengecek storage, tidak perlu handle redirect hash
             const existingToken = localStorage.getItem("access_token");
              let userFromStorage = JSON.parse(localStorage.getItem("user_info") || "null");
              let userFromSession = JSON.parse(sessionStorage.getItem("currentUser") || "null");

              if (existingToken && (userFromSession || userFromStorage)) {
                 console.log("Existing session found. Validating token (optional step)...");
                 // Di halaman detail, kita bisa skip validasi ulang token untuk performa
                 // Asumsikan valid jika ada token & user info di storage
                 if (!userFromSession && userFromStorage) { // Jika hanya ada di LS, salin ke SS
                     sessionStorage.setItem("currentUser", JSON.stringify({
                        id: userFromStorage.id || userFromStorage.sub,
                        name: userFromStorage.name,
                        picture: userFromStorage.picture,
                        email: userFromStorage.email
                     }));
                 }
                 console.log("Session assumed valid from storage.");
             } else {
                  console.log("No active session found in storage.");
                 // Pastikan bersih jika tidak ada token/user
                 localStorage.removeItem("access_token"); localStorage.removeItem("user_info"); sessionStorage.removeItem("currentUser");
             }
             await updateMenu(); // Update menu berdasarkan status akhir
        }
        // --- Akhir Fungsi Auth & Menu ---


        // --- Fungsi Detail Anime (Dari anime.html original) ---
        function getAnimeSlug() {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get("slug");
            return slug ? decodeURIComponent(slug).trim().toLowerCase() : null;
        }

        function renderAnimeInfo(anime) {
            document.title = `${anime.title} - Detail Anime | MyAnime`; // Tambahkan nama situs
            const titleElement = document.getElementById("anime-title");
            const imageElement = document.getElementById("anime-image");
            const descElement = document.getElementById("anime-desc");
            const metaContainer = document.getElementById("anime-meta");
            const genreContainer = document.getElementById("anime-genres");
            const downloadBtn = document.getElementById("download-btn");
            const streamingLink = document.getElementById("streaming-link");

            // Set Basic Info
            titleElement.textContent = anime.title || "Judul Tidak Tersedia"; // Fallback
            imageElement.src = anime.image || "Gambar/default-thumbnail.png"; // Fallback
            imageElement.alt = `Poster ${anime.title || 'Anime'}`; // Fallback
            descElement.textContent = anime.desc || "Sinopsis tidak tersedia."; // Fallback

            // --- Render Metadata yang Lebih Lengkap ---
            metaContainer.innerHTML = ""; // Kosongkan placeholder awal
            if (anime.info && typeof anime.info === 'object') {
                // Definisikan label yang diinginkan dan urutannya (opsional)
                const labels = {
                    type: "Tipe",
                    episodes: "Episode",
                    status: "Status",
                    aired: "Tayang",
                    premiered: "Premier",
                    broadcast: "Siaran",
                    producers: "Produser",
                    licensors: "Lisensor", // Tambahkan jika ada di JSON
                    studios: "Studio",
                    source: "Sumber",
                    themes: "Tema",       // Tambahkan Tema di sini
                    demographic: "Demografi", // Tambahkan Demografi
                    duration: "Durasi",
                    rating: "Rating",
                    // 'genres' akan ditangani terpisah di bawah
                };

                // Array untuk menampung elemen HTML metadata
                const metaElements = [];

                // Iterasi melalui label yang sudah didefinisikan agar urutannya bisa diatur
                for (const key in labels) {
                    if (Object.hasOwnProperty.call(anime.info, key)) {
                        const label = labels[key];
                        let value = anime.info[key];
                        let displayValue = null;

                        // Format value jika array (misal: Producers, Studios, Themes)
                        if (Array.isArray(value)) {
                            // Filter nilai kosong/null dalam array sebelum join
                            const validItems = value.filter(item => item && typeof item === 'string' && item.trim() !== '');
                            if (validItems.length > 0) {
                                displayValue = validItems.join(", ");
                            }
                        }
                        // Format value jika string biasa
                        else if (value && typeof value === 'string' && value.trim() !== '') {
                            displayValue = value;
                        }
                        // Format value jika number (misal: episodes)
                        else if (typeof value === 'number') {
                             displayValue = value.toString();
                        }

                        // Hanya tambahkan jika ada value yang valid untuk ditampilkan
                        if (displayValue) {
                            const div = document.createElement("div");
                            div.className = "info-item";
                            // Gunakan innerHTML agar <strong> bisa diparsing
                            div.innerHTML = `<strong>${label}:</strong> ${displayValue}`;
                            metaElements.push(div);
                        }
                    }
                }

                // Tambahkan semua elemen metadata ke container
                if (metaElements.length > 0) {
                    metaElements.forEach(el => metaContainer.appendChild(el));
                } else {
                    // Jika tidak ada info valid sama sekali
                    metaContainer.innerHTML = "<p class='info-item'>Informasi detail tidak tersedia.</p>";
                }

            } else {
                // Jika objek anime.info tidak ada
                metaContainer.innerHTML = "<p class='info-item'>Informasi detail tidak tersedia.</p>";
            }
            // --- Akhir Render Metadata ---


            // --- Render Genre (Sudah ada, tapi pastikan validasi) ---
            genreContainer.innerHTML = ""; // Kosongkan placeholder awal
            // Gunakan optional chaining (?) untuk keamanan
            const genres = anime.info?.genres;
            if (Array.isArray(genres) && genres.length > 0) {
                 let genreAdded = false;
                 genres.forEach((genre) => {
                     // Pastikan genre adalah string yang tidak kosong
                     if (genre && typeof genre === 'string' && genre.trim() !== '') {
                         const span = document.createElement("span");
                         span.className = "genre-tag";
                         span.textContent = genre.trim(); // Trim spasi ekstra
                         genreContainer.appendChild(span);
                         genreAdded = true;
                     }
                 });
                 // Jika setelah loop tidak ada genre valid yang ditambahkan
                 if (!genreAdded) {
                      genreContainer.innerHTML = "<p class='info-item'>Genre tidak tersedia.</p>";
                 }
            } else {
                genreContainer.innerHTML = "<p class='info-item'>Genre tidak tersedia.</p>";
            }
            // --- Akhir Render Genre ---


             // Tampilkan tombol aksi (logika ini sudah benar, tidak perlu diubah)
             downloadBtn.style.display = 'inline-flex';
             streamingLink.style.display = 'inline-flex';
        }        

        async function loadAnimeData() {
            console.log("Loading anime data...");
            const titleElement = document.getElementById("anime-title");
            const mainContainer = document.querySelector('main .container'); // Target container utama

            try {
                const slug = getAnimeSlug();
                if (!slug) throw new Error("Slug anime tidak ditemukan di URL.");
                console.log("Looking for slug:", slug);

                 // Fetch data (pastikan path anime-data.json benar)
                const response = await fetch("./anime-data.json", { cache: 'no-store' }); // Tambah no-store untuk debug
                 console.log("Fetch response status:", response.status);
                if (!response.ok) {
                    throw new Error(`Gagal memuat data (Status: ${response.status})`);
                }
                 const contentType = response.headers.get("content-type");
                 let fullData;
                 if (!contentType || !contentType.includes("application/json")) {
                     const text = await response.text();
                     try { fullData = JSON.parse(text); } catch(e){ throw new Error("Data bukan JSON valid."); }
                 } else {
                     fullData = await response.json();
                 }

                const dataArray = fullData.data || fullData; // Handle kedua struktur JSON

                if (!Array.isArray(dataArray)) {
                    throw new Error("Format data anime tidak valid (bukan array).");
                }

                const anime = dataArray.find(a => a.slug?.trim().toLowerCase() === slug);

                if (!anime) {
                    throw new Error(`Anime dengan slug "${slug}" tidak ditemukan.`);
                }

                console.log("Anime found:", anime.title);
                renderAnimeInfo(anime); // Render info ke elemen yang sudah ada

                // Handle tombol download
                const downloadBtn = document.getElementById("download-btn");
                if (anime.seasons?.length > 1) {
                     console.log("Multiple seasons found for download.");
                     downloadBtn.onclick = () => showSeasonPopup(anime.seasons);
                } else if (anime.download) {
                     console.log("Single download link found.");
                    downloadBtn.onclick = () => {
                        showLoader(() => window.open(anime.download, "_blank"));
                    };
                } else {
                    console.log("No download link found.");
                    downloadBtn.style.display = 'none'; // Sembunyikan jika tidak ada link
                }

                // Handle tombol streaming
                const streamingLink = document.getElementById("streaming-link");
                if (anime.seasons?.length > 1 && anime.seasons.some(s => s.streaming && s.streaming.length > 0)) { // Cek apakah ada link streaming di season
                     console.log("Multiple seasons found for streaming.");
                    streamingLink.onclick = (e) => {
                        e.preventDefault();
                        showStreamingSeasonPopup(anime.seasons, anime.slug);
                    };
                } else if (anime.streaming?.length > 0) { // Fallback ke struktur lama
                     console.log("Single streaming link/array found.");
                    streamingLink.href = `streaming.html?slug=${encodeURIComponent(anime.slug)}&season=0`;
                } else if (anime.seasons?.[0]?.streaming?.length > 0) { // Jika hanya 1 season tapi pakai struktur season
                     console.log("Single season with streaming links found.");
                     streamingLink.href = `streaming.html?slug=${encodeURIComponent(anime.slug)}&season=0`;
                 }
                 else {
                     console.log("No streaming link found.");
                    streamingLink.style.display = 'none'; // Sembunyikan jika tidak ada link
                }

            } catch (error) {
                console.error("Error loading anime data:", error);
                 // Tampilkan pesan error di halaman
                if (mainContainer) {
                    mainContainer.innerHTML = `
                        <a href="index.html" class="back-btn">← Kembali ke Beranda</a>
                        <div class="error-container">
                          <h1>⚠️ Gagal Memuat Data Anime</h1>
                          <p>${error.message || 'Terjadi kesalahan yang tidak diketahui.'}</p>
                        </div>`;
                } else {
                     document.body.innerHTML = `<div class="error-container"><h1>Error</h1><p>${error.message}</p><a href="index.html">Kembali</a></div>`; // Fallback
                }
                 // Update judul halaman jika error
                document.title = "Error Memuat Anime | MyAnime";
            }
        }

        // Fungsi loader
        function showLoader(callback) {
            const loader = document.getElementById("loader");
            const blurOverlay = document.getElementById("blur-overlay");
            if (!loader || !blurOverlay) return;
            loader.style.display = "block";
            blurOverlay.style.display = "block";
            setTimeout(() => {
                loader.style.display = "none";
                blurOverlay.style.display = "none";
                callback?.();
            }, 800); // Durasi loader sedikit lebih cepat
        }

        // Fungsi popup season download
        function showSeasonPopup(seasons) {
            const popup = document.getElementById("seasonPopup");
            const seasonList = document.getElementById("seasonList");
            const blurOverlay = document.getElementById("blur-overlay");
            if (!popup || !seasonList || !blurOverlay) return;

            // Filter season yang punya link download valid
            const validSeasons = seasons.filter(s => s && s.name && s.download);

            if (validSeasons.length === 0) {
                 showNotification("Link download belum tersedia untuk season manapun.", "info");
                 return;
            }

            seasonList.innerHTML = validSeasons.map(season => `
                <li class="season-item" onclick="handleDownloadClick('${season.download}')">
                    ${season.name}
                </li>`).join("");
            popup.style.display = "block";
            blurOverlay.style.display = "block";
        }
        // Handler klik item download
        function handleDownloadClick(url) {
            closeSeasonPopup();
            showLoader(() => window.open(url, '_blank'));
        }

        // Fungsi popup season streaming
        function showStreamingSeasonPopup(seasons, slug) {
    const popup = document.getElementById("streamingSeasonPopup");
    const seasonList = document.getElementById("streamingSeasonList");
    const blurOverlay = document.getElementById("blur-overlay");
     if (!popup || !seasonList || !blurOverlay) return;

     const validSeasons = seasons.filter(s => s && s.name && s.streaming && s.streaming.length > 0);

     if (validSeasons.length === 0) {
         showNotification("Link streaming belum tersedia untuk season manapun.", "info");
         return;
     }

    // GANTI BAGIAN ONCLICK DI BAWAH INI
    seasonList.innerHTML = validSeasons.map(season => `
        <li class="season-item"
            onclick="window.open('streaming.html?slug=${encodeURIComponent(slug)}&season_slug=${encodeURIComponent(season.season_slug)}', '_blank'); closeStreamingSeasonPopup()">
             ${season.name}
        </li>`).join("");

    popup.style.display = "block";
    blurOverlay.style.display = "block";
}
        

        // Fungsi tutup popup
        function closeSeasonPopup() {
            const popup = document.getElementById("seasonPopup");
            const blurOverlay = document.getElementById("blur-overlay");
            if (popup) popup.style.display = "none";
            if (blurOverlay) blurOverlay.style.display = "none";
        }

        function closeStreamingSeasonPopup() {
            const popup = document.getElementById("streamingSeasonPopup");
            const blurOverlay = document.getElementById("blur-overlay");
            if (popup) popup.style.display = "none";
            if (blurOverlay) blurOverlay.style.display = "none";
        }

        // Event listener untuk klik di luar popup (pada overlay)
        window.addEventListener('click', (event) => {
            const overlay = document.getElementById("blur-overlay");
            if (event.target === overlay) {
                closeSeasonPopup();
                closeStreamingSeasonPopup();
            }
        });
         // Event listener untuk tombol Escape
         window.addEventListener('keydown', (event) => {
             if (event.key === 'Escape') {
                 closeSeasonPopup();
                 closeStreamingSeasonPopup();
             }
         });


        // --- INISIALISASI HALAMAN ---
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("🚀 DOM loaded. Initializing Detail Page...");
            try {
                await initAuth(); // Inisialisasi otentikasi & menu dulu
                 await loadAnimeData(); // Kemudian load data anime spesifik
            } catch (error) {
                 console.error("Error during initialization:", error);
                 // loadAnimeData sudah menangani tampilan error di halaman
            }
            console.log("🏁 Detail Page Initialization complete.");
        });


    </script>

</body>
</html>